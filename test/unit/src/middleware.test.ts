/*
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
â–ˆâ–ˆ******************** PRESENTED BY t33n Software ***************************â–ˆâ–ˆ
â–ˆâ–ˆ                                                                           â–ˆâ–ˆ
â–ˆâ–ˆ                  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—                      â–ˆâ–ˆ
â–ˆâ–ˆ                  â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â•šâ•â•â•â•â–ˆâ–ˆâ•—â•šâ•â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘                      â–ˆâ–ˆ
â–ˆâ–ˆ                     â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘                      â–ˆâ–ˆ
â–ˆâ–ˆ                     â–ˆâ–ˆâ•‘    â•šâ•â•â•â–ˆâ–ˆâ•— â•šâ•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘                      â–ˆâ–ˆ
â–ˆâ–ˆ                     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘                      â–ˆâ–ˆ
â–ˆâ–ˆ                     â•šâ•â•   â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â•â•â•                      â–ˆâ–ˆ
â–ˆâ–ˆ                                                                           â–ˆâ–ˆ
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
*/

import sinon from 'sinon'

import {
    vi,
    describe, it, expect, beforeEach, afterEach
} from 'vitest'

import {
    ValidationError,
    ErrorType
} from '@/src/index'

import {
    default as errorMiddleware,
    SanitizedMessage,
    type IErrorResponseSanitized
} from '@/src/middleware'

import type { Request, Response, NextFunction } from 'express'

import { StatusCodes } from 'http-status-codes'

/**
 * ğŸ“¦ Test suite for the middleware in src/middleware.ts
 */
describe('[UNIT TEST] - src/middleware.ts', () => {
    /**
     * ğŸ“‹ Enum test suite for SanitizedMessage
     */
    describe('[ENUM]', () => {
        /**
         * ğŸ§ª Test case for SanitizedMessage enum values
         */
        it('should test types of SanitizedMessage enum', () => {
            expect(SanitizedMessage.DEFAULT).toBe('[SANITIZED]')
        })
    })

    /**
     * âš™ï¸ Code test suite to validate error handling
     */
    describe('[CODE]', () => {
        let jsonStub: sinon.SinonStub // ğŸ§ª JSON stub for response
        let statusStub: sinon.SinonStub // âš™ï¸ Status stub for response

        const errMsg = 'Test error' // âš ï¸ Error message for testing
        const errMsgOriginal = 'Test error original' // âš ï¸ Original error message
        const errData = { data: 'test' } // ğŸ“Š Additional error data
        const error: Error = new Error(errMsgOriginal) // ğŸ“¥ New error instance
        const validationErr = new ValidationError(errMsg, errData, error) // ğŸ“­ Validation error

        /**
         * ğŸ”„ Setup before each test case
         */
        beforeEach(() => {
            jsonStub = sinon.stub() // ğŸ”„ Create a stub for JSON response

            statusStub = sinon.stub().callsFake(() => ({ // ğŸ”„ Create a stub for status response
                json: jsonStub
            }))
        })

        /**
         * ğŸ” Cleanup after each test case
         */
        afterEach(() => {
            jsonStub.reset() // ğŸ”„ Reset JSON stub
            statusStub.reset() // ğŸ”„ Reset status stub
        })

        /**
         * ğŸ›¡ï¸ Response handling test suite
         */
        describe('[RESPONSE]', () => {
            /**
             * âŒ Test suite for handling non-sanitized responses
             */
            describe('[NOT SANITIZED]', () => {
                /**
                 * ğŸ”„ Setup environment for non-sanitized testing
                 */
                beforeEach(() => {
                    vi.stubEnv('npm_lifecycle_event', 'test') // ğŸŒ Set environment variable for testing
                })

                /**
                 * ğŸ§ª Test case for handling ValidationError with non-sanitized response
                 */
                it('should handle ValidationError and send a not sanitized JSON response because of NLE', () => {
                    const req = {} as Request // ğŸ“¥ Mock request object
                    const res = { status: statusStub } as unknown as Response // ğŸ“¤ Mock response object
                    const next = {} as NextFunction // ğŸ”„ Mock next function

                    /**
                     * ğŸ—‚ï¸ Expected response structure for non-sanitized error
                     */
                    const expectedResponse: IErrorResponseSanitized = {
                        name: ErrorType.VALIDATION, // âš ï¸ Error type
                        environment: process.env.npm_lifecycle_event!, // ğŸŒ Environment variable
                        timestamp: sinon.match.string as unknown as string, // â° Timestamp of error
                        message: errMsg, // âš ï¸ Error message
                        httpStatus: StatusCodes.BAD_REQUEST, // âš ï¸ HTTP status code
                        error: `Error: ${errMsgOriginal}` as unknown as string, // âš ï¸ Original error message
                        data: errData, // ğŸ“Š Error data
                        stack: sinon.match.string as unknown as string // ğŸ”„ Stack trace
                    }

                    errorMiddleware(validationErr, req, res, next) // ğŸ”„ Execute middleware

                    // âœ… Validate status call
                    expect(statusStub.calledOnceWithExactly(StatusCodes.BAD_REQUEST)).toBe(true) 
                    // âœ… Validate JSON response
                    expect(jsonStub.calledOnceWithExactly(expectedResponse)).toBe(true)
                })
            })

            /**
             * âœ… Test suite for handling sanitized responses
             */
            describe('[SANITIZED]', () => {
                /**
                 * ğŸ”„ Setup environment for sanitized testing
                 */
                beforeEach(() => {
                    vi.stubEnv('npm_lifecycle_event', 'start') // ğŸŒ Set environment variable for testing
                })

                /**
                 * ğŸ§ª Test case for handling errors with sanitized response
                 */
                it('should handle errors and send a sanitized JSON response because of NLE', () => {
                    const req = {} as Request // ğŸ“¥ Mock request object
                    const res = { status: statusStub } as unknown as Response // ğŸ“¤ Mock response object
                    const next = {} as NextFunction // ğŸ”„ Mock next function

                    /**
                     * ğŸ—‚ï¸ Expected response structure for sanitized error
                     */
                    const expectedResponse: IErrorResponseSanitized = {
                        name: ErrorType.VALIDATION, // âš ï¸ Error type
                        environment: process.env.npm_lifecycle_event!, // ğŸŒ Environment variable
                        timestamp: sinon.match.string as unknown as string, // â° Timestamp of error
                        message: errMsg, // âš ï¸ Error message
                        httpStatus: StatusCodes.BAD_REQUEST, // âš ï¸ HTTP status code
                        error: SanitizedMessage.DEFAULT, // âœ… Sanitized error message
                        data: SanitizedMessage.DEFAULT, // âœ… Sanitized data
                        stack: SanitizedMessage.DEFAULT // âœ… Sanitized stack trace
                    }

                    errorMiddleware(validationErr, req, res, next) // ğŸ”„ Execute middleware

                    // âœ… Validate status call
                    expect(statusStub.calledOnceWithExactly(StatusCodes.BAD_REQUEST)).toBe(true) 
                    // âœ… Validate JSON response
                    expect(jsonStub.calledOnceWithExactly(expectedResponse)).toBe(true)
                })
            })
        })
    })
})
